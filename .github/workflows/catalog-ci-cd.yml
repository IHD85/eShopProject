# Navn på workflowet, som vises i GitHub Actions
name: CI/CD - Catalog.API (Docker)

on:
  push:
    branches: [ main ]
    # VIGTIGT: Kør KUN hvis der er ændringer i Catalog.API's mappe
    paths:
      - 'Microservices/Catalog/Catalog.API/**'
      - '.github/workflows/catalog-ci-cd.yml' # Kør også, hvis vi ændrer denne fil

  # Kør dette workflow, når der oprettes/opdateres en Pull Request til 'main'
  pull_request:
    branches: [ main ]
    # VIGTIGT: Kør KUN hvis der er ændringer i Catalog.API's mappe
    paths:
      - 'Microservices/Catalog/Catalog.API/**'
      - '.github/workflows/catalog-ci-cd.yml' # Kør også, hvis vi ændrer denne fil
  
  # Tillad at man kan starte workflowet manuelt fra Actions-fanen
  workflow_dispatch:

jobs:
  # Omdøbt jobbet til at matche, hvad det rent faktisk gør
  build-and-push-docker:
    # Kør på en standard Ubuntu-maskine
    runs-on: ubuntu-latest

    # Trinene i jobbet
    steps:
      # Trin 1: Hent din kode ned til maskinen
      - name: Check out repository
        uses: actions/checkout@v4

      # Trin 2: Sæt Docker Buildx op (anbefales for bedre builds)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # Trin 3: Log ind på Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          # Sikrer, at du bruger samme secret i login som i push
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # Trin 4: Byg Docker image
      # --- Fjernet 'Setup .NET', 'Restore' og 'Build' trin ---
      # --- De er unødvendige, da din Dockerfile selv bygger projektet ---
      - name: Build Docker image
        run: |
          docker build \
            -f Microservices/Catalog/Catalog.API/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/catalog-api:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/catalog-api:${{ github.sha }} \
            .

      # Trin 5: Push image til Docker Hub
      # Tilføjet 'if' for KUN at pushe, når du pusher til 'main'-branchen
      - name: Push image to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/catalog-api:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/catalog-api:${{ github.sha }}