name: CI/CD - Microservices

on:
  push:
    branches: [ AdilBranch ] # master
    paths:
      # Lyt efter ændringer i alle relevante microservice- og gateway-mapper
      - 'Gateway/API.Gateway/**'
      - 'Microservices/Basket/eShop.Basket.API/**'
      - 'Microservices/Catalog/Catalog.API/**'
      - 'Microservices/Identity/Identity.API/**'
      - 'Microservices/Inventory/Inventory.API/**'
      - 'Microservices/Order/eShop.Order.API/**'
      # Lyt også på testprojekter og solution-filen
      - 'Catalog.API.UnitTests/**'
      - 'eShopProject.sln'
      # Og workflow-filen selv
      - '.github/workflows/microservices-ci-cd.yml'

  pull_request:
    branches: [ AdilBranch ] # master
    paths:
      # Samme mapper som ovenfor
      - 'Gateway/API.Gateway/**'
      - 'Microservices/Basket/eShop.Basket.API/**'
      - 'Microservices/Catalog/Catalog.API/**'
      - 'Microservices/Identity/Identity.API/**'
      - 'Microservices/Inventory/Inventory.API/**'
      - 'Microservices/Order/eShop.Order.API/**'
      - 'Catalog.API.UnitTests/**'
      - 'eShopProject.sln'
      - '.github/workflows/microservices-ci-cd.yml'
  
  workflow_dispatch:

jobs:
  # -----------------------------------------------
  # JOB 1: Byg og test hele .NET-løsningen
  # -----------------------------------------------
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      # Trin 1: Hent koden
      - name: Hent koden (Check out repository)
        uses: actions/checkout@v4

      # Trin 2: Sæt .NET 8 SDK op
      - name: Sæt .NET 8 SDK op (Setup .NET)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      # Trin 3: Gendan NuGet pakker (for hele solution)
      - name: Gendan NuGet pakker (Restore dependencies)
        run: dotnet restore eShopProject.sln

      # Trin 4: Byg hele løsningen
      - name: Byg løsningen (Build solution)
        run: dotnet build eShopProject.sln --configuration Release --no-restore

      # Trin 5: Kør ALLE tests i solution-filen
      - name: Kør enhedstests (Run unit tests)
        run: dotnet test eShopProject.sln --no-build --configuration Release
        
  # -----------------------------------------------
  # JOB 2: Byg og push Docker images (via Matrix)
  # -----------------------------------------------
  build-and-push-docker:
    # Kør KUN hvis 'build-and-test' jobbet er succesfuldt
    needs: build-and-test
    
    # Kør KUN på 'master' branchen for at undgå at pushe fra PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/AdilBranch'
    
    runs-on: ubuntu-latest
    
    strategy:
      # Definer en matrix for hver microservice med en Dockerfile
      matrix:
        include:
          - service-name: 'api-gateway'
            dockerfile-path: './Gateway/API.Gateway/Dockerfile'
            context-path: '.' # .NET Dockerfiles har ofte brug for solution root som context
          - service-name: 'basket-api'
            dockerfile-path: './Microservices/Basket/eShop.Basket.API/Dockerfile'
            context-path: '.'
          - service-name: 'catalog-api'
            dockerfile-path: './Microservices/Catalog/Catalog.API/Dockerfile'
            context-path: '.'
          - service-name: 'identity-api'
            dockerfile-path: './Microservices/Identity/Identity.API/Dockerfile'
            context-path: '.'
          - service-name: 'inventory-api'
            dockerfile-path: './Microservices/Inventory/Inventory.API/src/Dockerfile'
            context-path: './Microservices/Inventory/Inventory.API' # Node.js context er projektmappen
          - service-name: 'order-api'
            dockerfile-path: './Microservices/Order/eShop.Order.API/Dockerfile'
            context-path: '.'
            
    steps:
      # Trin 1: Hent koden
      - name: Hent koden (Check out repository)
        uses: actions/checkout@v4

      # Trin 2: Sæt Docker Buildx op
      - name: Sæt Docker Buildx op (Set up Docker Buildx)
        uses: docker/setup-buildx-action@v3
        
      # Trin 3: Log ind på Docker Hub
      - name: Log ind på Docker Hub (Login to Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # Trin 4: Byg og push Docker image (dette trin kører for hver service i matrixen)
      - name: Byg og push image for ${{ matrix.service-name }}
        uses: docker/build-push-action@v5
        with:
          # Brug context-stien fra matrixen
          context: ${{ matrix.context-path }}
          # Brug Dockerfile-stien fra matrixen
          file: ${{ matrix.dockerfile-path }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service-name }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service-name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max